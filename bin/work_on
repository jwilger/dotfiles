#!/usr/bin/env ruby
require 'rubygems'
gem 'activesupport'
require 'active_support'
require 'active_support/core_ext/string'

story_number = ARGV[0]

if story_number.blank?
  puts "USAGE: work_on {story_number}"
  puts "story_number is the ID of the story in ScrumNinja."
  exit 1
end

`git remote update`

branches = IO.popen('git branch -a') do |f|
  branches = f.readlines
end
branches = branches.map { |b| b.split('/').last.sub(/^\s*\*\s*/, '').strip }
branches = branches.uniq
branches = branches.select { |l| l =~ /.*#{Regexp.escape(story_number)}.*/ }

if branches.empty?
  puts "No remote or local branches contain the story ID #{story_number}."
  exit 2
end

puts "Select branch to work with:"
branches.each_with_index do |b,i|
  puts "     #{i+1}) #{b}"
end
print "Select a branch number or [c]ancel: "
selection = STDIN.gets.chomp.strip
branch_idx = selection.to_i - 1
exit 3 if branch_idx < 0
selected_branch = branches[branch_idx]
exit 3 if selected_branch.nil?
puts "Checking out git branch #{selected_branch}"
`git checkout #{selected_branch}`
exit $?
